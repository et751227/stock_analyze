<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>個股分析 (TWSE)</title>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", "Microsoft JhengHei", sans-serif; margin: 0; display: flex; height: 100vh; }
    #sidebar { width: 220px; background: #f7f7f7; border-right: 1px solid #ddd; padding: 20px; box-sizing: border-box; flex-shrink: 0; }
    #sidebar h3 { margin-top: 0; }
    .nav-parent { margin-top: 15px; margin-bottom: 5px; color: #666; font-weight: bold; padding-left: 15px; }
    .nav-link { display: block; padding: 10px 15px; text-decoration: none; color: #333; border-radius: 6px; cursor: pointer; }
    .nav-link:hover { background: #e9e9e9; }
    .nav-link.active { background: #007bff; color: white; font-weight: bold; }
    .nav-link.child { padding-left: 30px; }
    #main-content { flex: 1; padding: 24px; overflow-y: auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
    th { cursor: pointer; user-select: none; position: sticky; top: 0; background: #fafafa; z-index: 1; }
    tr:hover { background: #f8f8ff; }
    .hint { color: #666; font-size: 12px; margin-top: 8px; }
    .right { text-align: right; }
    hr { margin: 32px 0; border: 0; border-top: 1px solid #eee; }
    .table-container { max-height: 600px; overflow-y: auto; border: 1px solid #eee; border-bottom: none; margin-top: 16px; }
    .hidden { display: none; }
    .filter-group { display: flex; gap: 16px; align-items: center; background: #fafafa; padding: 16px; border-radius: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-group label { font-weight: 500; }
    .filter-group input, .filter-group select, .filter-group button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .filter-group input { width: 70px; }
    .search-container { position: relative; width: 100%; max-width: 500px; margin-bottom: 16px; }
    #stock-search-input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
    #autocomplete-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 300px; overflow-y: auto; z-index: 100; }
    .autocomplete-item { padding: 12px 15px; cursor: pointer; }
    .autocomplete-item:hover { background: #f0f0f0; }
    .autocomplete-item strong { color: #007bff; }
    #detail-results table { max-width: 600px; }
    #detail-results td:first-child { font-weight: 500; background: #fafafa; width: 30%; }
    .table-search { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; max-width: 300px; box-sizing: border-box; margin-bottom: 10px; }
  </style>
</head>
<body>

  <nav id="sidebar">
    <h3>分析項目</h3>
    <a class="nav-link" data-target="page-bwibbu">本益比/殖利率</a>
    <div class="nav-parent">我的模型分析</div>
    <a class="nav-link child" data-target="page-quadrant">四象限篩選</a>
    <a class="nav-link child" data-target="page-factor">多因子模型</a>
    <a class="nav-link" data-target="page-detail" style="margin-top: 15px;">個股查詢</a>
  </nav>

  <main id="main-content">
    <div class="hint">資料來源：TWSE OpenAPI (每日由 Cron Job 自動更新)</div>
    <hr>
    <div id="page-bwibbu" class="content-page">
      <h2>個股：本益比 / 殖利率 / 股價淨值比</h2>
      <div class="hint">此為 BWIBBU_d 資料表快照。點擊欄位可排序。</div>
      <input type="text" id="bwibbu-search-input" class="table-search" placeholder="篩選代碼或名稱...">
      <div class="table-container">
        <table id="t">
          <thead>
            <tr>
              <th data-key="Code">代碼</th><th data-key="Name">名稱</th><th class="right" data-key="PE">PE</th>
              <th class="right" data-key="DividendYield(%)">殖利率(%)</th><th class="right" data-key="PB">PB</th>
              <th data-key="FiscalYearQuarter">資料季度</th>
            </tr>
          </thead>
          <tbody id="t-body"></tbody>
        </table>
      </div>
    </div>
    <div id="page-quadrant" class="content-page hidden">
      <h2>我的模型分析 (四象限篩選)</h2>
      <div class="filter-group">
        <label for="pe-min">PE 範圍：</label> <input type="number" id="pe-min" value="0"> <span>到</span> <input type="number" id="pe-max" value="100">
        <label for="min-trade-value" style="margin-left: 16px;">最低成交金額(萬)：</label> <input type="number" id="min-trade-value" value="5000">
        <label for="quadrant-select" style="margin-left: 16px;">四象限：</label>
        <select id="quadrant-select">
          <option value="all">-- 全部顯示 --</option> <option value="low-pe-low-pb">PE 低 / PB 低</option> <option value="low-pe-high-pb">PE 低 / PB 高</option>
          <option value="high-pe-low-pb">PE 高 / PB 低</option> <option value="high-pe-high-pb">PE 高 / PB 高</option>
        </select>
        <button id="filter-button-quadrant" style="margin-left: 16px; background: #007bff; color: white; cursor: pointer;">開始分析</button>
      </div>
      <div class="hint">此模型會自動排除無效資料(N/A)，並依照殖利率(%)由高至低排序。</div>
      <input type="text" id="quadrant-search-input" class="table-search" placeholder="篩選代碼或名稱...">
      <div class="table-container">
        <table id="quadrant-table">
          <thead>
            <tr>
              <th>代碼</th><th>名稱</th><th class="right">殖利率(%)</th><th class="right">PE</th><th class="right">PB</th><th class="right">成交金額(億)</th>
            </tr>
          </thead>
          <tbody id="quadrant-table-body"></tbody>
        </table>
      </div>
    </div>
    <div id="page-factor" class="content-page hidden">
      <h2>我的模型分析 (多因子評分)</h2>
      <div class="filter-group">
        <label for="factor-pe-min">PE 範圍：</label> <input type="number" id="factor-pe-min" value="0"> <span>到</span> <input type="number" id="factor-pe-max" value="100">
        <label for="factor-min-trade-value" style="margin-left: 16px;">最低成交金額(萬)：</label> <input type="number" id="factor-min-trade-value" value="5000">
        <button id="filter-button-factor" style="margin-left: 16px; background: #007bff; color: white; cursor: pointer;">開始分析</button>
      </div>
      <div class="hint">分析模型 = 價值(PE 40%, PB 30%) + 品質(殖利率 30%)。已排除無效及低流動性資料。</div>
      <h3>最值得投資 Top 10 (分數最高)</h3>
      <div class="table-container" style="max-height: 450px;">
        <table id="factor-table-top">
          <thead>
            <tr>
              <th>代碼</th><th>名稱</th><th class="right">模型總分</th><th class="right">殖利率(%)</th><th class="right">PE</th><th class="right">PB</th><th class="right">成交金額(億)</th>
            </tr>
          </thead>
          <tbody id="factor-table-body-top"></tbody>
        </table>
      </div>
      <h3 style="margin-top: 24px;">最不值得投資 Top 10 (分數最低)</h3>
      <div class="table-container" style="max-height: 450px;">
        <table id="factor-table-bottom">
          <thead>
            <tr>
              <th>代碼</th><th>名稱</th><th class="right">模型總分</th><th class="right">殖利率(%)</th><th class="right">PE</th><th class="right">PB</th><th class="right">成交金額(億)</th>
            </tr>
          </thead>
          <tbody id="factor-table-body-bottom"></tbody>
        </table>
      </div>
    </div>
    <div id="page-detail" class="content-page hidden">
      <h2>個股查詢</h2>
      <div class="hint">輸入代碼或名稱 (例如 "2330" 或 "台積電")，系統會自動篩選。</div>
      <div class="search-container">
        <input type="text" id="stock-search-input" placeholder="輸入代碼或名稱..." autocomplete="off">
        <div id="autocomplete-results" class="hidden"></div>
      </div>
      <div id="detail-results"></div>
    </div>
  </main>

<script>
// --- DOM 選擇器 ---
const $tbody = document.querySelector("#t-body");
const $bwibbuSearchInput = document.getElementById("bwibbu-search-input");
const $peMinQuadrant = document.getElementById("pe-min");
const $peMaxQuadrant = document.getElementById("pe-max");
const $minTradeValueQuadrant = document.getElementById("min-trade-value");
const $quadrantSelect = document.getElementById("quadrant-select");
const $filterButtonQuadrant = document.getElementById("filter-button-quadrant");
const $quadrantSearchInput = document.getElementById("quadrant-search-input");
const $quadrantTbody = document.getElementById("quadrant-table-body");
const $peMinFactor = document.getElementById("factor-pe-min");
const $peMaxFactor = document.getElementById("factor-pe-max");
const $minTradeValueFactor = document.getElementById("factor-min-trade-value");
const $filterButtonFactor = document.getElementById("filter-button-factor");
const $factorTbodyTop = document.getElementById("factor-table-body-top");
const $factorTbodyBottom = document.getElementById("factor-table-body-bottom");
const $searchInput = document.getElementById("stock-search-input");
const $autocompleteResults = document.getElementById("autocomplete-results");
const $detailResults = document.getElementById("detail-results");

// --- 全域變數 ---
const PE_THRESHOLD = 15;
const PB_THRESHOLD = 2;
let rows = []; // 將存放 all_data
let rankedStocks = []; // 存放多因子模型的評分與排名結果
let sortState = { key: "PE", asc: true };

// --- 輔助函式 ---
function parseNum(v) { const n = Number(String(v || "").replace(/,/g, "").trim()); return isNaN(n) ? NaN : n; }
const formatTradeValue = (val) => { const num = parseNum(val); return isNaN(num) ? "N/A" : (num / 100000000).toFixed(2); };

// --- 頁面1 (BWIBBU) 相關函式 ---
function render(data = rows, query = "") {
  console.log(`[render] Called with data length: ${data.length}, query: "${query}"`); // Log 1
  let filteredData = data;
  const queryLower = query.trim().toLowerCase();
  if (queryLower) {
    filteredData = data.filter(r => {
      const codeStr = String(r.Code || ''); const nameStr = String(r.Name || '').toLowerCase();
      return codeStr.includes(queryLower) || nameStr.includes(queryLower);
    });
  }
  console.log(`[render] Filtered data length: ${filteredData.length}`); // Log 2
  $tbody.innerHTML = filteredData.map(r => `
    <tr><td>${r["Code"] ?? ""}</td><td>${r["Name"] ?? ""}</td>
    <td class="right">${r["PE"] ?? ""}</td><td class="right">${r["DividendYield(%)"] ?? ""}</td>
    <td class="right">${r["PB"] ?? ""}</td><td>${r["FiscalYearQuarter"] ?? ""}</td></tr>
  `).join("");
  console.log("[render] Render complete."); // Log 3
}
function sortBy(key) {
  console.log(`[sortBy] Sorting by key: "${key}"`); // Log 4
  const asc = (sortState.key === key) ? !sortState.asc : true;
  sortState = { key, asc };
  rows.sort((a, b) => {
    if (["PE", "DividendYield(%)", "PB"].includes(key)) {
      const x = parseNum(a[key]), y = parseNum(b[key]);
      if (isNaN(x) && isNaN(y)) return 0;
      if (isNaN(x)) return 1; if (isNaN(y)) return -1;
      return asc ? (x - y) : (y - x);
    } else {
      const x = (a[key] || "").toString(), y = (b[key] || "").toString();
      return asc ? x.localeCompare(y, 'zh-Hant') : y.localeCompare(x, 'zh-Hant');
    }
  });
  const currentQuery = $bwibbuSearchInput ? $bwibbuSearchInput.value : "";
  console.log(`[sortBy] Calling render with current query: "${currentQuery}"`); // Log 5
  render(rows, currentQuery);
}

// --- 頁面2 (四象限) 相關函式 ---
function renderQuadrantTable(data, query = "") {
  console.log(`[renderQuadrantTable] Called with data length: ${data.length}, query: "${query}"`); // Log 6
  let filteredData = data;
  const queryLower = query.trim().toLowerCase();
  if (queryLower) {
    filteredData = data.filter(r => {
      const codeStr = String(r.Code || ''); const nameStr = String(r.Name || '').toLowerCase();
      return codeStr.includes(queryLower) || nameStr.includes(queryLower);
    });
  }
  console.log(`[renderQuadrantTable] Filtered data length: ${filteredData.length}`); // Log 7
  $quadrantTbody.innerHTML = filteredData.map(r => `
    <tr><td>${r["Code"] ?? ""}</td><td>${r["Name"] ?? ""}</td>
    <td class="right">${r["DividendYield(%)"] ?? ""}</td><td class="right">${r["PE"] ?? ""}</td>
    <td class="right">${r["PB"] ?? ""}</td><td class="right">${formatTradeValue(r["TradeValue"])}</td></tr>
  `).join("");
  console.log("[renderQuadrantTable] Render complete."); // Log 8
}
function runQuadrantAnalysis() {
  console.log("[runQuadrantAnalysis] Function called"); // Log 9
  const minPE = parseNum($peMinQuadrant.value);
  const maxPE = parseNum($peMaxQuadrant.value);
  const minTradeValue = parseNum($minTradeValueQuadrant.value) * 10000;
  const quadrant = $quadrantSelect.value;
  let universe = rows.filter(stock => {
    const pe = parseNum(stock["PE"]); const pb = parseNum(stock["PB"]);
    const yieldVal = parseNum(stock["DividendYield(%)"]); const tradeValue = parseNum(stock["TradeValue"]);
    if (isNaN(pe) || isNaN(pb) || isNaN(yieldVal) || isNaN(tradeValue)) return false;
    if (tradeValue < minTradeValue) return false;
    return pe >= minPE && pe <= maxPE;
  });
  let quadrantData = universe.filter(stock => {
    const pe = parseNum(stock["PE"]); const pb = parseNum(stock["PB"]);
    switch (quadrant) {
      case "low-pe-low-pb": return pe < PE_THRESHOLD && pb < PB_THRESHOLD;
      case "low-pe-high-pb": return pe < PE_THRESHOLD && pb >= PB_THRESHOLD;
      case "high-pe-low-pb": return pe >= PE_THRESHOLD && pb < PB_THRESHOLD;
      case "high-pe-high-pb": return pe >= PE_THRESHOLD && pb >= PB_THRESHOLD;
      default: return true;
    }
  });
  quadrantData.sort((a, b) => {
    const yA = parseNum(a["DividendYield(%)"]); const yB = parseNum(b["DividendYield(%)"]);
    if (isNaN(yA) && isNaN(yB)) return 0; if (isNaN(yA)) return 1; if (isNaN(yB)) return -1;
    return yB - yA;
  });
  const currentQuery = $quadrantSearchInput ? $quadrantSearchInput.value : "";
  console.log(`[runQuadrantAnalysis] Calling renderQuadrantTable with data length: ${quadrantData.length}, query: "${currentQuery}"`); // Log 10
  renderQuadrantTable(quadrantData, currentQuery);
}

// --- 頁面3 (多因子) 相關函式 ---
function renderFactorModelTable(data, tbodyElement) {
  console.log(`[renderFactorModelTable] Rendering ${data.length} rows into ${tbodyElement.id}`); // Log F1
  tbodyElement.innerHTML = data.map(r => `
    <tr><td>${r["Code"] ?? ""}</td><td>${r["Name"] ?? ""}</td>
    <td class="right">${r["final_score"] ? r["final_score"].toFixed(2) : "N/A"}</td>
    <td class="right">${r["DividendYield(%)"] ?? ""}</td><td class="right">${r["PE"] ?? ""}</td>
    <td class="right">${r["PB"] ?? ""}</td><td class="right">${formatTradeValue(r["TradeValue"])}</td></tr>
  `).join("");
}
function runFactorModelAnalysis() {
  console.log("[runFactorModelAnalysis] Function called"); // Log F2
  const minPE = parseNum($peMinFactor.value);
  const maxPE = parseNum($peMaxFactor.value);
  const minTradeValue = parseNum($minTradeValueFactor.value) * 10000;
  console.log(`[runFactorModelAnalysis] Filters: PE ${minPE}-${maxPE}, Min TradeValue ${minTradeValue}`); // Log F3
  let universe = rows.filter(stock => {
    const pe = parseNum(stock["PE"]); const pb = parseNum(stock["PB"]);
    const yieldVal = parseNum(stock["DividendYield(%)"]); const tradeValue = parseNum(stock["TradeValue"]);
    if (isNaN(pe) || isNaN(pb) || isNaN(yieldVal) || isNaN(tradeValue)) return false;
    if (tradeValue < minTradeValue) return false;
    return pe >= minPE && pe <= maxPE;
  });
  console.log(`[runFactorModelAnalysis] Universe size: ${universe.length}`); // Log F4
  if (universe.length === 0) {
    $factorTbodyTop.innerHTML = `<tr><td colspan="7">沒有任何股票符合篩選條件。</td></tr>`;
    $factorTbodyBottom.innerHTML = `<tr><td colspan="7">沒有任何股票符合篩選條件。</td></tr>`;
    rankedStocks = []; // 清空排名
    return;
  }
  let scoredData = universe.map(stock => ({ ...stock }));
  scoredData.sort((a, b) => parseNum(a["PE"]) - parseNum(b["PE"]));
  scoredData.forEach((stock, index) => { stock.pe_score = 100 - (index / scoredData.length) * 100; });
  scoredData.sort((a, b) => parseNum(a["PB"]) - parseNum(b["PB"]));
  scoredData.forEach((stock, index) => { stock.pb_score = 100 - (index / scoredData.length) * 100; });
  scoredData.sort((a, b) => parseNum(b["DividendYield(%)"]) - parseNum(a["DividendYield(%)"]));
  scoredData.forEach((stock, index) => { stock.yield_score = 100 - (index / scoredData.length) * 100; });
  scoredData.forEach(stock => {
    stock.final_score = (stock.pe_score * 0.4) + (stock.pb_score * 0.3) + (stock.yield_score * 0.3);
  });
  scoredData.sort((a, b) => b.final_score - a.final_score);
  rankedStocks = scoredData.map((stock, index) => ({
    Code: stock.Code, final_score: stock.final_score, rank: index + 1
  }));
  console.log(`[runFactorModelAnalysis] Stored ${rankedStocks.length} ranked stocks globally.`);
  console.log(`[runFactorModelAnalysis] Scored data length: ${scoredData.length}`); // Log F5
  if (scoredData.length > 0) {
    console.log("[runFactorModelAnalysis] Top score:", scoredData[0].final_score, "Bottom score:", scoredData[scoredData.length - 1].final_score); // Log F6
  }
  renderFactorModelTable(scoredData.slice(0, 10), $factorTbodyTop);
  renderFactorModelTable(scoredData.slice(-10).reverse(), $factorTbodyBottom);
}

// --- 頁面4 (個股查詢) 相關函式 ---
function handleAutocomplete() {
  console.log("handleAutocomplete function called"); // Log 1
  const query = $searchInput.value.trim().toLowerCase();
  if (query.length === 0) { $autocompleteResults.classList.add("hidden"); return; }
  const matches = rows.filter(stock => {
    const codeStr = String(stock.Code || ''); const nameStr = String(stock.Name || '').toLowerCase();
    return codeStr.includes(query) || nameStr.includes(query);
  });
  console.log("Search query:", query, "Matches found:", matches.length); // Log 2
  if (matches.length === 0) { $autocompleteResults.classList.add("hidden"); return; }
  $autocompleteResults.innerHTML = matches.slice(0, 10).map(stock => {
    const codeDisplay = String(stock.Code || '').replace(new RegExp(query, 'gi'), '<strong>$&</strong>');
    const nameDisplay = String(stock.Name || '').replace(new RegExp(query, 'gi'), '<strong>$&</strong>');
    return `<div class="autocomplete-item" data-code="${stock.Code}" data-name="${stock.Name}">${codeDisplay} ${nameDisplay}</div>`;
  }).join("");
  console.log("Generated HTML:", $autocompleteResults.innerHTML.length > 0); // Log 3
  $autocompleteResults.classList.remove("hidden");
  console.log("Removed 'hidden' class from autocomplete results"); // Log 4
}
function handleSelectStock(e) {
  const item = e.target.closest('.autocomplete-item');
  if (!item) return;
  const code = item.dataset.code;
  const name = item.dataset.name;
  $searchInput.value = `${code} ${name}`;
  $autocompleteResults.classList.add("hidden");
  $detailResults.innerHTML = `<p>正在查詢 ${name} (${code}) 的詳細資料...</p>`;
  const allData = rows.find(r => r.Code === code) || {};
  renderStockDetails(allData);
}
function renderStockDetails(data) {
  const stockRankInfo = rankedStocks.find(r => r.Code === data.Code);
  const score = stockRankInfo ? stockRankInfo.final_score.toFixed(2) : "N/A (未評分)";
  const rank = stockRankInfo ? `${stockRankInfo.rank} / ${rankedStocks.length || 'N/A'}` : "N/A (未評分)";
  const displayFields = [
      { title: "代碼", key: "Code" }, { title: "名稱", key: "Name" },
      { title: "模型總分", value: score }, { title: "市場排名", value: rank },
      { title: "殖利率(%)", key: "DividendYield(%)" }, { title: "本益比 (PE)", key: "PE" },
      { title: "股價淨值比 (PB)", key: "PB" }, { title: "資料季度 (PE/PB)", key: "FiscalYearQuarter" },
      { title: "開盤價", key: "OpeningPrice" }, { title: "最高價", key: "HighestPrice" },
      { title: "最低價", key: "LowestPrice" }, { title: "收盤價", key: "ClosingPrice" },
      { title: "漲跌", key: "Change" }, { title: "成交筆數", key: "Transaction" },
      { title: "成交金額", key: "TradeValue" }, { title: "成交股數", key: "TradeVolume" }
  ];
  let html = `<h3>${data.Name || 'N/A'} (${data.Code || 'N/A'}) 詳細資料</h3>
              <table><tbody>`;
  displayFields.forEach(field => {
      let value;
      if (field.value !== undefined) { value = field.value; }
      else { value = data[field.key]; }
      if ((value !== undefined && value !== "") || field.title === "模型總分" || field.title === "市場排名") {
          let displayValue = value;
          if (field.key === "TradeValue") { displayValue = formatTradeValue(value) + " 億"; }
          html += `<tr><td>${field.title}</td><td>${displayValue}</td></tr>`;
      }
  });
  html += `</tbody></table>`;
  $detailResults.innerHTML = html;
}

// --- 系統啟動與事件綁定 ---
async function load() {
  console.log("[load] Starting data fetch..."); // Log 11
  try {
      const res = await fetch("/api/view");
      const j = await res.json();
      if (!j.ok) {
          console.error(`載入資料失敗: ${j.error}`);
          throw new Error(`Failed to load data: ${j.error}`);
      }
      rows = j.all_data || [];
      console.log(`[load] Data loaded, total rows: ${rows.length}`); // Log 12
      // 注意：不再預先呼叫 sortBy("PE")，讓 startup 處理
  } catch (error) {
      console.error("[load] Error during fetch or processing:", error); // Log L-Error
      throw error; // 將錯誤拋出，讓 startup 知道
  }
}

const navLinks = document.querySelectorAll(".nav-link");
const contentPages = document.querySelectorAll(".content-page");
function showPage(pageId) {
  contentPages.forEach(page => { page.classList.add("hidden"); });
  const targetPage = document.getElementById(pageId);
  if (targetPage) { targetPage.classList.remove("hidden"); }
  navLinks.forEach(link => {
    if (link.dataset.target === pageId) { link.classList.add("active"); }
    else { link.classList.remove("active"); }
  });
}
navLinks.forEach(link => {
  link.addEventListener("click", (e) => {
    e.preventDefault();
    const targetPageId = link.dataset.target;
    showPage(targetPageId);
  });
});

async function startup() {
  console.log("[startup] Starting application..."); // Log S1
  try {
    console.log("[startup] Calling load()..."); // Log S2
    await load(); // 等待資料載入完成
    console.log("[startup] load() completed."); // Log S3

    console.log("[startup] Binding event listeners..."); // Log S4
    document.querySelectorAll("#t th[data-key]").forEach(th => th.addEventListener("click", () => sortBy(th.dataset.key)));
    if ($bwibbuSearchInput) { $bwibbuSearchInput.addEventListener('input', () => render(rows, $bwibbuSearchInput.value)); }
    else { console.error("找不到元素: bwibbu-search-input"); }
    if ($filterButtonQuadrant) { $filterButtonQuadrant.addEventListener('click', runQuadrantAnalysis); }
    else { console.error("找不到元素: filter-button-quadrant"); }
    if ($quadrantSearchInput) { $quadrantSearchInput.addEventListener('input', runQuadrantAnalysis); }
    else { console.error("找不到元素: quadrant-search-input"); }
    if ($filterButtonFactor) { $filterButtonFactor.addEventListener('click', runFactorModelAnalysis); }
    else { console.error("找不到元素: filter-button-factor"); }
    console.log("[startup] Checking $searchInput..."); // Log S5
    if ($searchInput) {
        console.log("[startup] $searchInput found. Adding event listener..."); // Log S6
        $searchInput.addEventListener('input', handleAutocomplete);
        console.log("[startup] Event listener added for $searchInput."); // Log S7
    } else {
        console.error("找不到元素: stock-search-input"); // Log S8
    }
    if ($autocompleteResults) { $autocompleteResults.addEventListener('click', handleSelectStock); }
    else { console.error("找不到元素: autocomplete-results"); }
    document.addEventListener('click', (e) => {
      if ($searchInput && !$searchInput.contains(e.target) && $autocompleteResults) {
        $autocompleteResults.classList.add('hidden');
      }
    });
    console.log("[startup] Event listeners bound."); // Log S9

    console.log("[startup] Initializing pages and running analyses..."); // Log S10
    sortBy("PE"); // 執行預設排序 (這會觸發 render)
    runQuadrantAnalysis(); // 預先執行四象限分析
    runFactorModelAnalysis(); // 預先執行多因子分析
    showPage("page-bwibbu"); // 最後才顯示預設頁面
    console.log("[startup] Application started successfully."); // Log S11

  } catch (error) {
      console.error("[startup] An error occurred during startup:", error); // Log S12
      // (可以考慮在這裡顯示一個錯誤訊息給使用者，例如修改 main-content 的內容)
      const mainContent = document.getElementById("main-content");
      if (mainContent) {
          mainContent.innerHTML = `<h2 style="color: red;">應用程式啟動失敗</h2><p>載入資料時發生錯誤，請稍後再試或檢查 Console 紀錄。</p><pre>${error.message}</pre>`;
      }
  }
}
startup(); // 啟動

</script>
</body>
</html>
